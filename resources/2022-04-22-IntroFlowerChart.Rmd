---
title: ''
output: bookdown::html_document2
---


<style type="text/css">

body{ /* Normal  */
      font-size: 18px;
  }
td {  /* Table  */
  font-size: 12px;
}
h1.title {
  font-size: 38px;
  color: DarkRed;
}
h1 { /* Header 1 */
  font-size: 28px;
  color: #77BE2D;
}
h2 { /* Header 2 */
    font-size: 22px;
  color: #77BE2D;
}
h3 { /* Header 3 */
  font-size: 18px;
  font-family: "Times New Roman", Times, serif;
  color: #77BE2D;
}
code.r{ /* Code block */
    font-size: 12px;
}
pre { /* Code block - determines code spacing between lines */
    font-size: 14px;
}
ul {
  list-style: none; /* Remove default bullets */
}

ul li::before {
  content: "\2022";  /* Add content: \2022 is the CSS Code/unicode for a bullet */
  color: #D2C2AA; /* Change the color */
  font-weight: bold; /* If you want it to be bold */
  display: inline-block; /* Needed to add space between the bullet and the text */
  width: 1em; /* Also needed for space (tweak if needed) */
  margin-left: -1em; /* Also needed for space (tweak if needed) */
}
</style>



<div>
<div style="display: flex; justify-content:flex-end">
<img src="images/logo.png" height = "75" width="67"></div>
</div>

<div style="display:grid; grid-template-columns:repeat(2,minmax(0,1fr))">
<div style="margin-left:0.5rem; margin-right:5.5rem">
  <div><div style="display: flex; justify-content:flex-center"><img src="images/michael.png"/></div>
  </div>
  <left style="color:#2D2D69">Michael Ohler Consulting</left><br>
  <left style="color:#2D2D69">Buchsbaumweg 6</left><br> 
  <left style="color:#2D2D69">D-22880 Wedel</left><br>
  <left><a style="color:#77BE2D" href="http://www.ohlermichael.de" target="_blank">
   http://www.ohlermichael.de
  </a></left>
  
  <h1 style="color:#77BE2D; font-size:1.5rem">
  Systematic and people-oriented<br/> 
  methods for strategy, improvement and innovation</h1>
  </div>

  <div ><h1 style="color:#2D2D69; font-size:4.7rem";>
  Analytical tools to study the evolution of democracy: the "flower chart"</h1> 
  <p style="color:#808080">April 22nd 2022, by Michael Ohler<p/><br>

  </div>
</div>


<div><left style="color:#203864"><h2>What this study is about</h2></left></div>

<div>
For the previous two studies, I have explored data that are made avaiable by the [State of Democracy website](https://www.idea.int/data-tools/tools/global-state-democracy-indices). With 5 attributes, 3+4+4+3+2 sub-attributes, 8 sub-sub-attributes and 116 indices the dataset is both impressively rich and confusing to a novice. 
</div>
<div>
In this study, I experiment with a graphical interface to explore all these data at once, either for a given country or a group of countries. For that purpose, I arrange attributes and indices in a "flower-chart", inspired by the artwork used by the State of Democracy team. 
</div>
<div>
What still needs to be fixed is to display the labels of all these attributes and indices.
</div>



```{r setup, include=FALSE}
rm(list=ls())

# Make sure ggplot graphs have dates in English language
Sys.setlocale("LC_TIME", "English")

# Colors:
purple <- "#2D2D69" # dark purple
green <- "#77BE2D" # MOC green
lightgreen <- "#d8e4bc"
orange <- "#FFA500"
myred <- "darkred"
grey <- "#808080"


################################
# Libraries
################################

library(tidyverse)
library(readxl)

library(formattable) # table output
library(kableExtra) # other table output
library(ggpubr)
library(ggrepel)
library(plotly)
library(viridis)

source("helper.R")
```



```{r echo=FALSE, include=FALSE, message=FALSE, warning=FALSE}
################################
# Read in and scrub the data
################################



# General: matching country data from different databases is a nightmare.
# The main issue is that some country names don't match and that some small countries may be included in one but not in the other database.

# State of Democracy data.
# Downloaded from: https://www.idea.int/gsod-indices/dataset-resources
# Data are manually prepared. See Excel file how that is done. Notice the "dont.use" CountryName.
t <- read_excel("Data/GSoDI_v5.1_1975-2020_v2.xlsx", sheet = "Updated") %>%
  filter(CountryName != "X.dont.use") %>%
  mutate_at(vars(matches("^C_|L_|U_|v_")),funs(as.numeric)) %>% 
  filter(ID_year < 2019) %>%    # This is done to match the available data for the population size
  filter(CountryName %notin% c("Palestine", "Israel", "Taiwan")) %>% # same
  select(-ID_country_name) # avoid all confusing: CountryName is the correct column (see Excel file)

# These population data are downloaded from the world bank (available until 2018)
pop <- read_excel("Data/GSoDI_v5.1_1975-2020_v2.xlsx", sheet = "PopulationUpdated") %>%
  filter(CountryUpdated != "X.dont.use") %>% select(Year, CountryUpdated, Population)
colnames(pop) <- c("Year", "Country", "Population")


# Indicator explanation file. Manually created by Anna Zhuravska from the "Codebook":
indicator.table <- read_excel("Data/IndicatorMap.xlsx", sheet = "Indicators")
indicator.hierarchy <- read_excel("Data/IndicatorMap.xlsx", sheet = "Hierarchy")

# Merge the population data with the democracy-data
t <- left_join(t, pop, by = c("CountryName" = "Country", "ID_year" = "Year"))


# We now want to create a column with "indicator labels".
# These are to be used for pulldown menus in Shiny.
# TODO: The for-loop is quite clumsy. I don't find a more "transparent" way...

indicator.table$Prefix <- NA

for(i in 1:nrow(indicator.table)) {
  text <- indicator.table$Indicator[i]
  
  if(nchar(text) == 4) {
    n <- substr(text, 4, 4)
    indicator.table$Prefix[i] <- paste(n," ", sep = "")}

  if(nchar(text) == 6) {
    n <- substr(text, 5, 5)
    m <- substr(text, 6, 6)
    indicator.table$Prefix[i] <- paste(n, ".", m," ", sep = "")}
  
  if((substr(text, 1,4) == "C_SD") & (nchar(text) == 7)) {
    n <- substr(text, 5, 5)
    m <- substr(text, 6, 6)
    p <- substr(text, 7, 7)
    indicator.table$Prefix[i] <- paste(n, ".", m, ".", p, " ", sep = "")}
  
  if((substr(text, 1,1) == "v") & (nchar(text) == 7)) {
    n <- substr(text, 3, 3)
    m <- substr(text, 4, 4)
    p <- substr(text, 6, 6)
    q <- substr(text, 7, 7)
    indicator.table$Prefix[i] <- paste(n, ".", m, ".", p, ".", q, " ", sep = "")}

}

# TODO: Strangely, this indicator does not exist in the data. Needs clarification with idea.int.
# Here we don't use summarise(C_A5 = mean(c_across(everything()), na.rm = TRUE)):
t$C_A5 <- t %>% select(C_SD51, C_SD52, C_SD53, C_SD54) %>% rowwise() %>% summarise(C_A5 = mean(c_across(everything()))) %>% pull()
t$C_A0 <- t %>% select(C_A1, C_A2, C_A3, C_A4, C_A5) %>% rowwise() %>% summarise(C_A0 = mean(c_across(everything()))) %>% pull()

# We re-arrange the columns:
t <- t %>% select(-starts_with(c("U", "L"))) %>% select(starts_with(c("ID", "C_A", "C_SD", "v_")), everything())

indicator.table$Indicator.Label <- paste(indicator.table$Prefix, indicator.table$Indicator.Name, sep = "")
indicator.table <- indicator.table %>% arrange(Indicator.Label)
indicator.table$Indicator.Label <- factor(indicator.table$Indicator.Label, levels = indicator.table$Indicator.Label)
```


\
\

# All indices and attributes, averaged for the world


\

The following chart averages all indices over the world population. For that purpose, a given index is weighted by the population of the countries. We see that some indices (outer ring) are more developed than others (yellow). We also notice that "direct democracy" is least developed:

```{r echo=FALSE, message=FALSE, warning=FALSE}
# We create a table for all indices, averaged over the world population.
# A subselection for certain regions can be done by filtering t for the countries or regions.
weighted.indices <- weighted.indices.table(t)
```



```{r echo=FALSE, message=FALSE, warning=FALSE, fig.cap = "The 5 attributes, 16 sub-attributes, 8 sub-sub-attributes and 116 indices tracked by State of Democracy. The values for all countries displayed here as global average, weighted by the size of the population.", out.width = "100%"}
year <- "2018"
centertext <- paste("World", year, sep = " - ")

line <- weighted.indices %>% filter(ID_year == year)
create.flower.chart(line, centertext)
```


\
\

# Indices for one country


\

In the following we study a few countries:
 

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.cap = "Flower-plot for one country.", out.width = "100%"}
year <- "2018"
country <- "Germany"
centertext <- paste(country, year, sep = " - ")

line <- t %>% filter(ID_year == year, CountryName == country)
create.flower.chart(line, centertext)
```

\


```{r echo=FALSE, message=FALSE, warning=FALSE, fig.cap = "Flower-plot for one country.", out.width = "100%"}
year <- "2018"
country <- "Brazil"
centertext <- paste(country, year, sep = " - ")

line <- t %>% filter(ID_year == year, CountryName == country)
create.flower.chart(line, centertext)
```


\


```{r echo=FALSE, message=FALSE, warning=FALSE, fig.cap = "Flower-plot for one country.", out.width = "100%"}
year <- "2018"
country <- "Lebanon"
centertext <- paste(country, year, sep = " - ")

line <- t %>% filter(ID_year == year, CountryName == country)
create.flower.chart(line, centertext)
```


\


```{r echo=FALSE, message=FALSE, warning=FALSE, fig.cap = "Flower-plot for one country.", out.width = "100%"}
year <- "2018"
country <- "Turkey"
centertext <- paste(country, year, sep = " - ")

line <- t %>% filter(ID_year == year, CountryName == country)
create.flower.chart(line, centertext)
```


\


```{r echo=FALSE, message=FALSE, warning=FALSE, fig.cap = "Flower-plot for one country.", out.width = "100%"}
year <- "2008"
country <- "Turkey"
centertext <- paste(country, year, sep = " - ")

line <- t %>% filter(ID_year == year, CountryName == country)
create.flower.chart(line, centertext)
```


\


```{r echo=FALSE, message=FALSE, warning=FALSE, fig.cap = "Flower-plot for one country.", out.width = "100%"}
year <- "1998"
country <- "Turkey"
centertext <- paste(country, year, sep = " - ")

line <- t %>% filter(ID_year == year, CountryName == country)
create.flower.chart(line, centertext)
```



\


```{r echo=FALSE, message=FALSE, warning=FALSE, fig.cap = "Flower-plot for one country.", out.width = "100%"}
year <- "1988"
country <- "Turkey"
centertext <- paste(country, year, sep = " - ")

line <- t %>% filter(ID_year == year, CountryName == country)
create.flower.chart(line, centertext)
```


\


```{r echo=FALSE, message=FALSE, warning=FALSE, fig.cap = "Flower-plot for one country.", out.width = "100%"}
year <- "1978"
country <- "Turkey"
centertext <- paste(country, year, sep = " - ")

line <- t %>% filter(ID_year == year, CountryName == country)
create.flower.chart(line, centertext)
```


\
\

# Still do do


\

For a given year, the "flower-chart" functionality provides a good overview over all indices. What still needs to be implemented is:  

* Print the names of the indices on the chart; some re-arrangement of the circles is probably needed for that  
* Allow for a mouse-over-effect for an html-based report (which is easier to read than all labels printed on the graph)  
* Add connection lines to the graph between indices and their "parent attribute" (only needed for the "V_..." indices).  
 


